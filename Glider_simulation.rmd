---
title: "Simulated underwater glider sampling for Antarctic krill"
author:
  - Doug Kinzey, AERD
date: "07/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction


These functions simulate the use of autonomous underwater gliders to sample the acoustic energy attributable to Antarctic kril. A database of krill acoustic densities collected during US AMLR ship surveys from two strata in CCAMLR Subarea 48.1 from 1992 to 2011 is sampled using the sawtooth vertical pattern of underwater gliders equiped with echosounders that ensonify the water column vertically 100 m below the gliders. The gliders sample in an up and down pattern (each descent and return is called a 'yo') to a maximum depth of between 150 or 1000 m per dive. The gliders only ensonify the first 250 m of the water column regardless of maximum yo depth.


# Load the databases
There are two databases: (1) 'NASC_leg1.RData' (dimensions 100 x 199772), the krill acoustic values binned into cells 100 m horizontal by 5 m vertical, and (2) 'leg1.csv' (dimensions 199772 x 5), the unique identifiers, strata and year for each column of 'NASC_leg1.RData'.

```{r load_data}
load('NASC_leg1.RData')
leg1 <- read.csv('leg1.csv')
```

# Source the R code
There are two R scripts containing two functions. The first script, 'gldry.r', contains the 'gldry()' function, which calculates the path a glider would follow from a given starting position and maximum yo depth. It is sourced by the 'gldrs()' function in 'gldrs.r' the second script. 'gldrs()' reads the input parameters and calculates four input parameters that are passed to 'gldry()'. 'gldry()' calculates the glider sampling pattern and returns this pattern and three other parameters to 'gldrsl()' which then uses the glider sampling pattern on the acoustic database.

```{r}
source('gldry.r')
source('gldrs.r')
```

# Input parameters
There are nine input parameters to run a base simulation.

'NASC.yrs' are the years to be sampled, with a maximum range of 'c(2001:2009,2011)' (the sampling strata in the database were unsampled by the ships in 2010).

'AMLR.area' can be one of two values 'SA' (the southern area, Bransfield Strait) or 'WA' (the western area, Cape Shirreff).

'n.rep' is the number of replicated sets of glider samples to collect, '9' in the example. Run-time increases with increasing replicates.

'n.gldr' is the number of gliders sampling the stratum during each replicate. It can be a scalar or a vector of values representing sequentially increasing numbers of gliders. When 'n.gldr()' is a vector it will overwrite the results with each new group of gliders so the simulation results in this case need to be saved as tables (save.tables = 1) and then accessed for analysis using read.table().  Run-time increases with increasing gliders/replicate. Run times for 500 replicates of 5 glider/replicate can take over a week and can run out of memory on a 24 thread 32 GB RAM PC.

'max.NASC.m' is the maximum depth ensonified by the gliders. In the example, the echosounder is turned off at 150 m regardless of the maximum yo depth so this is always 250m.

'depths' are the maximum yo depths to be simulated.

'azfp.off' is a vector of the same length as 'depths'. This allows the option to ensonify deeper during deeper dives. The maximum depth of krill densities recorded in the database is 500 m.

'qntl.vals' allow the proportions of krill in these highly skewed distributions to be assessed.

'smpl.st' allows either random (=0) starting positions in the database for each replicate sample, or using the same starting positions (=1) for each replicate as a previous simulation. If this option is desired, save.tables = 1 for the previous simulation, and then the 'gldr_strt_ ...' files from the first run need to be called from the second run. 


```{r}
NASC.yrs = c(2001:2009,2011)
AMLR.area = 'SA'
n.rep = 9
n.gldr = c(1)
save.tables = 1
max.NASC.m = 250
depths = c(150,1000)
azfp.off = c(150,150)
qntl.vals = c(0.97,0.98,0.99,0.999,1)
smpl.st = 0
```

# Run the simulation

```{r}
Sys.time() # keep track of runtime

gldrs(NASC.yrs,AMLR.area,n.rep,n.gldr,
                      save.tables,max.NASC.m,depths,azfp.off,
                      qntl.vals,smpl.st)
Sys.time()
```


