---
title: "Glider sampling simulation figures 2 to 7"
author:
  - Doug Kinzey, AERD
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load the database of acoustic backscatter coefficients (s[A])
'NASC_leg1.RData' (dimensions 100 x 199772) contains the krill nautical area scattering coefficients (s[A]) binned into 100 m horizontal by 5 m vertical cells  (transposed in the simulation functions for easier visualization).

```{r load_data}
Sys.time()
load('NASC_leg1.RData')
```

```{r}
NASC.yrs = c(2001:2009,2011)
AMLR.area = 'SA'
n.rep = 14
n.gldr = c(1,2,3,4,5)
save.tables = 1
max.NASC.m = 250
depths = c(150,200,300,400,500,700,1000)
azfp.off = c(150,150,150,150,150,150,150) 
qntl.vals = c(0.97,0.98,0.99,0.999,1)
smpl.st = 0
```

# Figure 2: Sample paths of 3 yos to maximum depth of 150 m, and 1000 m
```{r f2, ,fig.width=7,fig.height=7, fig.show="hold", out.width="50%"}
source('Fig2.r')
Fig2()

Fig2(yo.depths.m=rep(1000,3),max.z.m=1005)
```

Figure 2. Schematic sample path of a glider completing 3 dives at with a maximum depth of (a) 150 m and (b) 1000 m. In each case the echosounder is shut off at 150 m, but the water column is ensonified to 250 m. Black cells indicate when the echosounder is recording and light gray represents the 100 m sampled below the glider. We computed a mean backscatter across the cells within each depth bin sampled during a dive and then summed vertically to produce glider samples of depth-integrated backscatter.

# Figure 3: Plot the summed s[A] at each 5m depth in the database

'Fig3.r' calculates a plot of the summed s[A] values at each depth, illustrating the overall relationship of krill density with depth.
```{r fig3, fig.width=3.5,fig.height=4}
source('Fig3.r')
```

Figure 3. Mean nautical area backscattering coefficients (s[A], m^2 nmi^-2) in 5 m depth bins of the population being sampled by simulated gliders for both strata and all years combined.

# Figure 4: Plot the CV of s[A]  and the proportion of zero density bins at each 5m depth in the database
```{r fig4, fig.width=7,fig.height=7, fig.show="hold", out.width="50%"}
source('Fig4.r')
```

Figure 4. CVs of acoustic backscatter (left) and proportions of bins with zero acoustic energy (right) at depth in the combined database sampled by the simulated gliders.

# Figure 5

Figure 5 shows the fit of the glider samples ('gldr.smpls.yrs') of acoustic density (s[A]) to the operating model values ('ship.sums') for each strata and year. 'plot_Sa_fits.r' plots the fits of the glider samples (grey) to the operating model (red). Figure 5 requires 'Glider_simulation.rmd' to have been already rendered to provide the data.

```{r Fig5, ,fig.width=7,fig.height=7, fig.show="hold", out.width="50%"}
source('Fig5.r')
Fig5(NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,n.rep=n.rep,n.gldr=n.gldr[1],
    qntl.vals=c(qntl.vals,'sum','sd'),depths=depths,azfp.off=azfp.off)
```

Figure 5. Annual glider log sample means and SDs (blue) from individual replicates (gray) of 1 glider with a maximum yo depth of 150 m sampling acoustic energy (s[A]) with individual yos as sampling units. In all plots, the population means (from the original ship surveys) are in red.

# Figure 6

The acoustic densities at depth from the ship surveys (the 'operating model') and the sampled densities from all replicate gliders, from one glider, and from five gliders at depth.

```{r fig6, fig.width=7,fig.height=7, fig.show="hold", out.width="50%"}
source('Fig6.r')
Fig6(depths=depths[1],AMLR.area=AMLR.area,max.z.b = 50,n.gldr=n.gldr[1],
     NASC.yrs=NASC.yrs,n.rep=n.rep)
```
Figure 6. Mean acoustic energy contours with depth each year in the sampled population and as sampled by different numbers of gliders with maximum yo depths of 150 m. The population energies, the mean of all glider replicates, the mean of 1 glider replicate and the mean of 3 glider replicates are shown.

# Figure 7

These example contour plots represent from 1 to 5 gliders sampling the database of acoustic densities. More replicates (i.e., 500) would illustrate the statistical fits more accurately, but can require several weeks of run time.

```{r fig7, fig.width=7,fig.height=7, fig.show="hold", out.width="50%"}
source('Fig7.r')
Fig7(n.gldr = c(1),NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,n.rep=n.rep,
     qntl.vals=c(qntl.vals,'sum','sd'),depths=depths)
Fig7(n.gldr = c(2),NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,n.rep=n.rep,
     qntl.vals=c(qntl.vals,'sum','sd'),depths=depths)
Fig7(n.gldr = c(3),NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,n.rep=n.rep,
     qntl.vals=c(qntl.vals,'sum','sd'),depths=depths)
Fig7(n.gldr = c(4),NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,n.rep=n.rep,
     qntl.vals=c(qntl.vals,'sum','sd'),depths=depths)
Fig7(n.gldr = c(5),NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,n.rep=n.rep,
     qntl.vals=c(qntl.vals,'sum','sd'),depths=depths)
```

Contour plots of numbers of glider combinations X maximum depth X year require at least 3 maximum yo depths and at least 3 glider combinations (i.e., 1 to 5 gliders per replicate).

```{r fig7_contours, fig.width=7,fig.height=7, fig.show="hold", out.width="50%"}
source('Fig7_contours.r')
Fig7_contours(n.gldr = n.gldr,NASC.yrs=NASC.yrs,AMLR.area=AMLR.area,
              n.rep=n.rep,depths=depths)
Sys.time()
```
